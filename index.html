<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>准时保 - 战友实时在线</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --sat: env(safe-area-inset-top);
      --sab: env(safe-area-inset-bottom);
    }
    
    html, body {
      height: 100%; width: 100%; margin: 0; padding: 0;
      background-color: #000000; overflow: hidden; position: fixed;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      -webkit-tap-highlight-color: transparent;
      user-select: none; -webkit-user-select: none;
      color: #f1f5f9;
    }

    #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
    .safe-top { padding-top: var(--sat); }
    .safe-bottom { padding-bottom: var(--sab); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    .glass {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    @keyframes pulse-cyan {
      0%, 100% { box-shadow: 0 0 15px rgba(6, 182, 212, 0.2); }
      50% { box-shadow: 0 0 30px rgba(6, 182, 212, 0.5); }
    }
    .animate-pulse-cyan { animation: pulse-cyan 2s infinite; }

    @keyframes pulse-green {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.4); opacity: 0.4; }
    }
    .status-dot-live { animation: pulse-green 1.2s infinite; }

    .btn-active:active { transform: scale(0.95); transition: transform 0.1s; }
  </style>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@^19.2.3",
      "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
      "@google/genai": "https://esm.sh/@google/genai@^1.37.0",
      "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
      "react/": "https://esm.sh/react@^19.2.3/"
    }
  }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Users, Timer, Skull, Zap, CheckCircle2, 
      History, Sparkles, Share2, Plus, Edit2, 
      Trash2, Clock, Globe, CloudSync, Loader2, Wifi
    } from 'lucide-react';

    const API_BASE = "https://jsonblob.com/api/jsonBlob";

    const playSound = (type) => {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        if (type === 'success') {
          osc.frequency.setValueAtTime(600, ctx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
          g.gain.setValueAtTime(0.1, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
          osc.start(); osc.stop(ctx.currentTime + 0.2);
        }
      } catch(e) {}
    };

    const App = () => {
      const [members, setMembers] = useState(() => JSON.parse(localStorage.getItem('sq_m') || '[]'));
      const [activeMission, setActiveMission] = useState(() => JSON.parse(localStorage.getItem('sq_a') || 'null'));
      const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('sq_h') || '[]'));
      const [roomID, setRoomID] = useState(() => localStorage.getItem('sq_rid') || '');
      const [isSyncing, setIsSyncing] = useState(false);
      const [isManaging, setIsManaging] = useState(false);
      const [isSettingRoom, setIsSettingRoom] = useState(false);
      const [loadingAI, setLoadingAI] = useState(false);
      const [timeLeft, setTimeLeft] = useState(0);

      const syncInProgress = useRef(false);
      const lastRemoteTimestamp = useRef(0);

      // 本地持久化
      useEffect(() => {
        localStorage.setItem('sq_m', JSON.stringify(members));
        localStorage.setItem('sq_a', JSON.stringify(activeMission));
        localStorage.setItem('sq_h', JSON.stringify(history));
        localStorage.setItem('sq_rid', roomID);
      }, [members, activeMission, history, roomID]);

      // URL 直达房间
      useEffect(() => {
        const rid = new URLSearchParams(window.location.search).get('room');
        if (rid && rid !== roomID) {
          setRoomID(rid);
          fetchRoomData(rid);
        }
      }, []);

      // 强效轮询：每 4 秒拉取一次，防止“各走各的”
      useEffect(() => {
        if (!roomID) return;
        const interval = setInterval(() => {
          fetchRoomData(roomID, true);
        }, 4000);
        return () => clearInterval(interval);
      }, [roomID]);

      // 倒计时
      useEffect(() => {
        if (!activeMission || activeMission.status !== 'waiting') return;
        const timer = setInterval(() => {
          const diff = Math.max(0, activeMission.endTime - Date.now());
          setTimeLeft(diff);
          if (diff <= 0) {
            clearInterval(timer);
            handleExpire();
          }
        }, 1000);
        return () => clearInterval(timer);
      }, [activeMission]);

      const fetchRoomData = async (id, isSilent = false) => {
        if (!id || syncInProgress.current) return;
        if (!isSilent) setIsSyncing(true);
        syncInProgress.current = true;
        try {
          // 关键：添加 cb 参数强制跳过浏览器缓存
          const res = await fetch(`${API_BASE}/${id}?cb=${Date.now()}`);
          if (!res.ok) throw new Error("Cloud down");
          const data = await res.json();
          
          // 只有云端数据版本更新时才覆盖本地
          if (data.updatedAt && data.updatedAt > lastRemoteTimestamp.current) {
            lastRemoteTimestamp.current = data.updatedAt;
            if (data.members) setMembers(data.members);
            if (data.history) setHistory(data.history);
            setActiveMission(data.activeMission || null);
          }
        } catch (e) {
          console.warn("Sync pulse failed");
        } finally {
          if (!isSilent) setIsSyncing(false);
          syncInProgress.current = false;
        }
      };

      const pushRoomData = async (overwriteState = null) => {
        if (!roomID) return;
        const state = overwriteState || { members, history, activeMission };
        state.updatedAt = Date.now(); // 标记更新时间
        
        try {
          await fetch(`${API_BASE}/${roomID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(state)
          });
        } catch (e) {
          console.error("Broadcast failed");
        }
      };

      const createRoom = async () => {
        setIsSyncing(true);
        try {
          const res = await fetch(API_BASE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ members, history, activeMission, updatedAt: Date.now() })
          });
          const id = res.headers.get("Location").split("/").pop();
          setRoomID(id);
          alert(`房间创建！ID: ${id}\n已连接实时同步服务器。`);
        } catch (e) { alert("创建失败"); } finally { setIsSyncing(false); }
      };

      const handleExpire = async () => {
        setLoadingAI(true);
        const lates = activeMission.participants.filter(p => !p.checked);
        const newHistory = [...history];
        const newMembers = [...members];
        for (const p of lates) {
          const m = newMembers.find(x => x.id === p.id);
          if (m) {
            m.penalties += activeMission.amount;
            newHistory.unshift({ id: Date.now()+Math.random(), name: m.name, amount: activeMission.amount, game: activeMission.game, time: new Date().toLocaleTimeString(), roast: "这货又放鸽子了。" });
          }
        }
        const nextState = { members: newMembers, history: newHistory, activeMission: null, updatedAt: Date.now() };
        setMembers(newMembers);
        setHistory(newHistory);
        setActiveMission(null);
        setLoadingAI(false);
        if (roomID) await pushRoomData(nextState);
      };

      const startMission = async (game, amount, minutes, selectedIds) => {
        const mission = { game, amount, endTime: Date.now() + minutes * 60000, status: 'waiting', participants: selectedIds.map(id => ({ id, checked: false })) };
        setActiveMission(mission);
        if (roomID) await pushRoomData({ members, history, activeMission: mission, updatedAt: Date.now() });
      };

      const toggleCheck = async (id) => {
        const next = { ...activeMission };
        const p = next.participants.find(x => x.id === id);
        if (p) p.checked = !p.checked;
        setActiveMission(next);
        playSound('success');
        if (roomID) await pushRoomData({ members, history, activeMission: next, updatedAt: Date.now() });
      };

      const copyShareLink = () => {
        const url = `${window.location.origin}${window.location.pathname}?room=${roomID}`;
        navigator.clipboard.writeText(url);
        alert("房间链接已复制！发送给朋友，大家状态就同步了。");
      };

      return React.createElement('div', { className: "flex flex-col w-full h-full bg-[#050505] text-white overflow-hidden" },
        // Header
        React.createElement('header', { className: "px-6 pt-12 pb-4 glass shrink-0 flex justify-between items-end safe-top shadow-2xl z-50" },
          React.createElement('div', { className: "flex items-center gap-3" },
            React.createElement('div', { className: "bg-cyan-500 p-2.5 rounded-xl shadow-[0_0_20px_rgba(6,182,212,0.4)]" }, React.createElement(Zap, { className: "text-black", size: 20 })),
            React.createElement('div', null,
              React.createElement('h1', { className: "text-xl font-black italic tracking-tighter uppercase" }, "准时保 · 实时版"),
              React.createElement('div', { className: "flex items-center gap-1.5 mt-0.5" },
                React.createElement('div', { className: `w-2 h-2 rounded-full ${roomID ? 'bg-emerald-500 status-dot-live' : 'bg-slate-700'}` }),
                React.createElement('span', { className: "text-[9px] text-slate-400 font-bold uppercase tracking-widest" }, roomID ? `LIVE ROOM: ${roomID}` : 'OFFLINE')
              )
            )
          ),
          React.createElement('div', { className: "flex gap-2" },
            React.createElement('button', { onClick: () => fetchRoomData(roomID), className: `p-2.5 rounded-xl bg-white/5 transition-all ${isSyncing ? 'text-cyan-400' : 'text-slate-500'}` }, 
              isSyncing ? React.createElement(Loader2, { className: "animate-spin", size: 18 }) : React.createElement(Wifi, { size: 18 })
            )
          )
        ),

        // Main
        React.createElement('main', { className: "flex-1 overflow-y-auto no-scrollbar p-5 space-y-6" },
          React.createElement('div', { className: "max-w-md mx-auto space-y-6 pb-24" },
            // Mission Card
            React.createElement('section', { className: "glass rounded-[2.5rem] p-7 border-t border-white/10 shadow-inner" },
              !activeMission ? 
                React.createElement('div', { className: "space-y-6" },
                  React.createElement('div', { className: "flex items-center gap-2 text-cyan-400 font-black text-[10px] uppercase tracking-[0.2em]" }, React.createElement(Timer, { size: 14 }), " 新集结指令"),
                  React.createElement(MissionForm, { members, onStart: startMission })
                ) : 
                React.createElement('div', { className: "space-y-7" },
                  React.createElement('div', { className: "flex justify-between items-start" },
                    React.createElement('div', null,
                      React.createElement('p', { className: "text-cyan-400 text-[10px] font-black uppercase tracking-widest" }, activeMission.game),
                      React.createElement('h3', { className: "text-2xl font-black italic uppercase leading-tight mt-1" }, "正在集结...")
                    ),
                    React.createElement('div', { className: "text-4xl font-mono font-black text-white tabular-nums drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]" }, `${Math.floor(timeLeft / 60000)}:${String(Math.floor((timeLeft % 60000) / 1000)).padStart(2, '0')}`)
                  ),
                  React.createElement('div', { className: "space-y-3" },
                    activeMission.participants.map(p => {
                      const m = members.find(x => x.id === p.id);
                      return React.createElement('div', { key: p.id, className: `flex items-center justify-between p-4 rounded-2xl border transition-all duration-500 ${p.checked ? 'bg-emerald-500/10 border-emerald-500/30' : 'bg-white/5 border-white/5'}` },
                        React.createElement('span', { className: `font-black text-lg ${p.checked ? 'text-emerald-400' : 'text-slate-300'}` }, m?.name),
                        !p.checked ? React.createElement('button', { onClick: () => toggleCheck(p.id), className: "bg-white text-black px-5 py-2.5 rounded-xl text-[10px] font-black uppercase btn-active shadow-xl" }, "我上线了") : React.createElement(CheckCircle2, { className: "text-emerald-500", size: 24 })
                      );
                    })
                  ),
                  React.createElement('button', { onClick: () => { setActiveMission(null); if(roomID) pushRoomData({members, history, activeMission: null, updatedAt: Date.now()}); }, className: "w-full py-4 bg-red-500/10 rounded-2xl text-[10px] font-black uppercase text-red-400 border border-red-500/10 btn-active" }, "终止集结广播")
                )
            ),

            // Ranking
            React.createElement('section', { className: "space-y-4" },
              React.createElement('div', { className: "flex justify-between items-end px-2" },
                React.createElement('h4', { className: "text-[10px] font-black text-red-500 uppercase tracking-widest flex items-center gap-2" }, React.createElement(Skull, { size: 14 }), " 鸽子身价榜"),
                React.createElement('button', { onClick: () => setIsManaging(true), className: "text-[10px] text-slate-600 font-black uppercase" }, "管理名单")
              ),
              React.createElement('div', { className: "space-y-2.5" },
                members.sort((a,b) => b.penalties - a.penalties).map((m, i) => React.createElement('div', { key: m.id, className: "glass p-5 rounded-2xl flex justify-between items-center border-l-2 border-transparent hover:border-cyan-500 transition-all" },
                  React.createElement('div', { className: "flex items-center gap-4" },
                    React.createElement('span', { className: `w-6 h-6 flex items-center justify-center rounded-lg text-[10px] font-black ${i===0 && m.penalties > 0 ? 'bg-red-500 text-white shadow-lg' : 'bg-white/5 text-slate-500'}` }, i+1),
                    React.createElement('span', { className: "font-black text-lg" }, m.name)
                  ),
                  React.createElement('span', { className: `font-mono font-black text-xl ${m.penalties > 0 ? 'text-red-500' : 'text-slate-800'}` }, `¥${m.penalties}`)
                ))
              )
            )
          )
        ),

        // Nav
        React.createElement('nav', { className: "glass border-t border-white/5 px-10 pt-4 pb-12 flex justify-around items-center safe-bottom" },
          React.createElement('button', { onClick: () => setIsManaging(true), className: "flex flex-col items-center gap-1.5 text-slate-500" }, React.createElement(Users, { size: 22 }), React.createElement('span', { className: "text-[9px] font-black uppercase" }, "名单")),
          React.createElement('div', { className: "relative -mt-14" },
            React.createElement('button', { onClick: roomID ? copyShareLink : () => setIsSettingRoom(true), className: "bg-cyan-500 text-black p-4.5 rounded-full shadow-[0_0_30px_rgba(6,182,212,0.4)] btn-active ring-4 ring-black scale-110" }, React.createElement(Share2, { size: 26 }))
          ),
          React.createElement('button', { onClick: () => setIsSettingRoom(true), className: "flex flex-col items-center gap-1.5 text-slate-500" }, React.createElement(Globe, { size: 22 }), React.createElement('span', { className: "text-[9px] font-black uppercase" }, "房间"))
        ),

        // Overlays
        isManaging && React.createElement(MemberManager, { members, setMembers, onClose: () => setIsManaging(false), onDataChange: (n) => { if(roomID) pushRoomData({members: n, history, activeMission, updatedAt: Date.now()}); } }),
        isSettingRoom && React.createElement(RoomOverlay, { roomID, setRoomID, createRoom, fetchRoomData, copyShareLink, onClose: () => setIsSettingRoom(false) }),
        loadingAI && React.createElement('div', { className: "fixed inset-0 z-[100] bg-black/90 backdrop-blur-xl flex flex-col items-center justify-center gap-5" },
          React.createElement(Sparkles, { className: "text-cyan-400 animate-bounce", size: 50 }),
          React.createElement('span', { className: "text-[11px] font-black uppercase tracking-[0.5em] text-cyan-400 animate-pulse" }, "正在更新鸽子名单...")
        )
      );
    };

    const MissionForm = ({ members, onStart }) => {
      const [game, setGame] = useState('英雄联盟');
      const [amount, setAmount] = useState(1);
      const [mins, setMins] = useState(5);
      const [selected, setSelected] = useState([]);

      return React.createElement('div', { className: "space-y-5" },
        React.createElement('input', { type: "text", placeholder: "什么游戏？", value: game, onChange: e => setGame(e.target.value), className: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 text-base font-black outline-none focus:border-cyan-500" }),
        React.createElement('div', { className: "grid grid-cols-2 gap-4" },
          React.createElement('div', { className: "bg-white/5 border border-white/10 rounded-2xl flex items-center px-4" },
            React.createElement('span', { className: "text-red-500 font-black mr-2 text-lg" }, "¥"),
            React.createElement('input', { type: "number", value: amount, onChange: e => setAmount(Number(e.target.value)), className: "bg-transparent border-none w-full py-4 font-black outline-none" })
          ),
          React.createElement('div', { className: "bg-white/5 border border-white/10 rounded-2xl flex items-center px-4" },
            React.createElement(Clock, { size: 18, className: "text-amber-500 mr-3" }),
            React.createElement('input', { type: "number", value: mins, onChange: e => setMins(Number(e.target.value)), className: "bg-transparent border-none w-full py-4 font-black outline-none" })
          )
        ),
        React.createElement('div', { className: "space-y-3" },
          React.createElement('p', { className: "text-[9px] text-slate-500 font-black uppercase tracking-wider" }, "点击选择必须到场的战友:"),
          React.createElement('div', { className: "flex flex-wrap gap-2.5" },
            members.map(m => React.createElement('button', { 
              key: m.id, 
              onClick: () => setSelected(prev => prev.includes(m.id) ? prev.filter(id => id !== m.id) : [...prev, m.id]),
              className: `px-4 py-2.5 rounded-xl border text-xs font-black uppercase transition-all ${selected.includes(m.id) ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400' : 'bg-white/5 border-white/5 text-slate-500'}`
            }, m.name))
          )
        ),
        React.createElement('button', { onClick: () => onStart(game, amount, mins, selected), className: "w-full bg-white text-black py-4.5 rounded-2xl font-black text-sm uppercase tracking-widest btn-active shadow-2xl" }, "全员广播：发起集结")
      );
    };

    const MemberManager = ({ members, setMembers, onClose, onDataChange }) => {
      const [name, setName] = useState('');
      const add = () => { if(name){ const n = [...members, { id: Date.now(), name, penalties: 0 }]; setMembers(n); onDataChange(n); setName(''); } };
      return React.createElement('div', { className: "fixed inset-0 z-[110] glass flex flex-col p-8 pt-20 animate-in fade-in" },
        React.createElement('div', { className: "max-w-md mx-auto w-full space-y-7" },
          React.createElement('div', { className: "flex justify-between items-center" },
            React.createElement('h2', { className: "text-2xl font-black italic uppercase" }, "战友名单"),
            React.createElement('button', { onClick: onClose, className: "text-slate-500 font-black text-xs uppercase" }, "完成")
          ),
          React.createElement('div', { className: "flex gap-2" },
            React.createElement('input', { type: "text", placeholder: "新战友名字", value: name, onChange: e => setName(e.target.value), className: "flex-1 bg-black/50 border border-white/10 rounded-2xl px-5 py-4 font-black" }),
            React.createElement('button', { onClick: add, className: "bg-white text-black px-6 rounded-2xl font-black" }, React.createElement(Plus, { size: 22 }))
          ),
          React.createElement('div', { className: "space-y-3 max-h-[60vh] overflow-y-auto no-scrollbar" },
            members.map(m => React.createElement('div', { key: m.id, className: "bg-white/5 p-5 rounded-2xl flex justify-between items-center" },
              React.createElement('span', { className: "font-black text-lg" }, m.name),
              React.createElement('div', { className: "flex gap-3" },
                React.createElement('button', { onClick: () => {if(confirm('重置罚款？')) { const n = members.map(x => x.id === m.id ? {...x, penalties: 0} : x); setMembers(n); onDataChange(n); }}}, React.createElement(Edit2, { size: 18, className: "text-slate-500" })),
                React.createElement('button', { onClick: () => { const n = members.filter(x => x.id !== m.id); setMembers(n); onDataChange(n); } }, React.createElement(Trash2, { size: 18, className: "text-red-500/40" }))
              )
            ))
          )
        )
      );
    };

    const RoomOverlay = ({ roomID, setRoomID, createRoom, fetchRoomData, copyShareLink, onClose }) => (
      React.createElement('div', { className: "fixed inset-0 z-[110] glass flex flex-col p-8 pt-20 animate-in fade-in" },
        React.createElement('div', { className: "max-w-md mx-auto w-full space-y-8" },
          React.createElement('div', { className: "flex justify-between items-center" },
            React.createElement('h2', { className: "text-2xl font-black italic uppercase" }, "连接开黑中心"),
            React.createElement('button', { onClick: onClose, className: "text-slate-500 font-black text-xs uppercase" }, "关闭")
          ),
          React.createElement('div', { className: "bg-white/5 p-7 rounded-[2.5rem] border border-white/10 space-y-6" },
            React.createElement('div', { className: "space-y-3" },
              React.createElement('label', { className: "text-[10px] font-black text-slate-500 uppercase px-1" }, "房间唯一标识码"),
              React.createElement('div', { className: "flex gap-2" },
                React.createElement('input', { type: "text", value: roomID, onChange: e => setRoomID(e.target.value), placeholder: "输入房间 ID", className: "flex-1 bg-black/50 border border-white/10 rounded-xl px-5 py-4 font-mono font-black text-cyan-400 outline-none" }),
                roomID && React.createElement('button', { onClick: () => fetchRoomData(roomID), className: "bg-white text-black px-5 rounded-xl font-black text-[11px] uppercase" }, "加入")
              )
            ),
            React.createElement('div', { className: "grid grid-cols-2 gap-3" },
              React.createElement('button', { onClick: createRoom, className: "bg-cyan-500 text-black py-4 rounded-2xl font-black text-[11px] uppercase" }, "创建我的房间"),
              React.createElement('button', { onClick: copyShareLink, disabled: !roomID, className: "bg-white/10 text-white py-4 rounded-2xl font-black text-[11px] uppercase disabled:opacity-30" }, "分享链接")
            )
          ),
          React.createElement('p', { className: "text-[11px] text-slate-500 text-center font-medium leading-relaxed px-6 uppercase tracking-wider" }, "连接房间后，所有名单和集结指令将自动在所有手机上同步更新。")
        )
      )
    );

    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>